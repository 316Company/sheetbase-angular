{"version":3,"file":"user.service.js","sourceRoot":"","sources":["../../../src/services/user.service.ts"],"names":[],"mappings":"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","sourcesContent":["import { Injectable, NgZone } from '@angular/core';\nimport { Observable } from 'rxjs';\n\nimport * as PubSub from 'pubsub-js';\nimport * as localforage from 'localforage';\n\nimport { UserDataService } from './user-data.service';\nimport { ApiService } from './api.service';\n\n@Injectable()\nexport class UserService {\n\n  constructor(\n    private ngZone: NgZone,\n\n    private userDataService: UserDataService,\n    private apiService: ApiService,\n  ) {\n  }\n\n  getToken() { return this.userDataService.token }\n\n  getUser() { return this.userDataService.user }\n\n  onAuthStateChanged(): Observable<any> {\n    return new Observable(observer => {\n      localforage.getItem<any>('sheetbaseAuthData')\n      .then(data => {\n\n        // save data\n        this.ngZone.run(() => {\n          this.userDataService.user = data.user;\n          this.userDataService.token = data.token;\n        });\n\n        observer.next(data ? data.user: null);\n      }).catch(error => {\n        observer.next(null);\n      });\n\n      PubSub.subscribe('SHEETBASE_AUTH_STATE_CHANGED', (msg, data) => {\n        observer.next(data ? data.user: null);\n      });\n    });\n  }\n\n  createUserWithEmailAndPassword(email: string, password: string): Promise<any> {\n    return new Promise((resolve, reject) => {\n      if(!email || !password) return reject('Missing email or password!');\n\n      this.apiService.POST('/user/create', {},\n        {\n          credential: {\n            email,\n            password\n          }\n        }\n      ).then(response => {\n        if(response.error) return reject(response);\n        // save data\n        this.ngZone.run(() => {\n          this.userDataService.user = response.data.user;\n          this.userDataService.token = response.data.token;\n        });\n\n        localforage.setItem('sheetbaseAuthData', response.data)\n        .then(() => {return})\n        .catch(error => {return});\n\n        PubSub.publish('SHEETBASE_AUTH_STATE_CHANGED', response.data);\n        resolve(response);\n      }).catch(reject);\n    });\n  }\n\n  loginWithEmailAndPassword(email: string, password: string) {\n    return new Promise((resolve, reject) => {\n      if(!email || !password) return reject('Missing email or password!');\n\n      if(this.userDataService.user) resolve({\n        token: this.userDataService.token,\n        user: this.userDataService.user\n      });\n\n      this.apiService.POST('/user/login', {},\n        {\n          credential: {\n            email,\n            password\n          }\n        }\n      ).then(response => {\n        if(response.error) return reject(response);\n\n        // save data\n        this.ngZone.run(() => {\n          this.userDataService.user = response.data.user;\n          this.userDataService.token = response.data.token;\n        });\n\n        localforage.setItem('sheetbaseAuthData', response.data)\n        .then(() => {return})\n        .catch(error => {return});\n\n        PubSub.publish('SHEETBASE_AUTH_STATE_CHANGED', response.data);\n        resolve(response);\n      }).catch(reject);\n    });\n  }\n\n  signOut(): Promise<any> {\n    return new Promise((resolve, reject) => {\n      this.userDataService.user = null;\n      this.userDataService.token = null;\n\n      localforage.removeItem('sheetbaseAuthData')\n      .then(() => {return})\n      .catch(error => {return});\n\n      PubSub.publish('SHEETBASE_AUTH_STATE_CHANGED', null);\n      resolve(null);\n    });\n  }\n\n  updateProfile(profile: any): Promise<any> {\n    return new Promise((resolve, reject) => {\n      if(!profile || !(profile instanceof Object)) return reject('Invalid profile data.');\n\n      if(!this.userDataService.user || !this.userDataService.token) return reject('Please login first!');\n\n      this.apiService.POST('/user/profile', {},\n        {\n          profile\n        }\n      ).then(response => {\n        if(response.error) return reject(response);\n\n        // save data\n        this.ngZone.run(() => {\n          this.userDataService.user = response.data.user;\n        });\n\n        localforage.setItem('sheetbaseAuthData', {\n          token: this.userDataService.token,\n          user: response.data.user\n        })\n        .then(() => {return})\n        .catch(error => {return});\n\n        PubSub.publish('SHEETBASE_AUTH_STATE_CHANGED', response.data);\n        resolve(response.data.user);\n      }).catch(reject);\n    });\n  }\n\n  resetPasswordEmail(email: string): Promise<any> {\n    return new Promise((resolve, reject) => {\n      if(!email) return reject('Missing email!');\n\n      this.apiService.POST('/auth/reset-password', {},\n        {\n          email\n        }\n      ).then(response => {\n        if(response.error) return reject(response);\n        resolve(response);\n      }).catch(reject);\n    });\n  }\n\n  setPassword(oobCode: string, password: string): Promise<any> {\n    return new Promise((resolve, reject) => {\n      if(!oobCode || !password) return reject('Missing oobCode or password!');\n\n      this.apiService.POST('/auth/set-password', {},\n        {\n          oobCode,\n          password\n        }\n      ).then(response => {\n        if(response.error) return reject(response);\n        resolve(response);\n      }).catch(reject);\n    });\n  }\n\n\n  verifyCode(oobCode: string): Promise<any> {\n    return new Promise((resolve, reject) => {\n      if(!oobCode) return reject('Missing oobCode!');\n\n      this.apiService.POST('/auth/verify-code', {},\n        {\n          oobCode\n        }\n      ).then(response => {\n        if(response.error) return reject(response);\n        resolve(response);\n      }).catch(reject);\n    });\n  }\n\n}\n"]}