{"version":3,"file":"user.service.js","sourceRoot":"","sources":["../../../src/services/user.service.ts"],"names":[],"mappings":"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","sourcesContent":["import { Injectable, NgZone } from '@angular/core';\nimport { Observable } from 'rxjs';\n\nimport * as PubSub from 'pubsub-js';\nimport * as localforage from 'localforage';\n\nimport { UserDataService } from './user-data.service';\nimport { ApiService } from './api.service';\n\n@Injectable()\nexport class UserService {\n\n  constructor(\n    private ngZone: NgZone,\n\n    private userDataService: UserDataService,\n    private apiService: ApiService,\n  ) {\n  }\n\n  getToken() { return this.userDataService.token }\n\n  getUser() { return this.userDataService.user }\n\n  onAuthStateChanged(): Observable<any> {\n    return new Observable(observer => {\n      localforage.getItem<any>('sheetbaseAuthData')\n      .then(data => {\n\n        // save data\n        this.ngZone.run(() => {\n          this.userDataService.user = data.user;\n          this.userDataService.token = data.token;\n        });\n\n        observer.next(data ? data.user: null);\n      }).catch(error => {\n        observer.next(null);\n      });\n\n      PubSub.subscribe('SHEETBASE_AUTH_STATE_CHANGED', (msg, data) => {\n        observer.next(data ? data.user: null);\n      });\n    });\n  }\n\n  createUserWithEmailAndPassword(email: string, password: string): Promise<any> {\n    return new Promise((resolve, reject) => {\n      this.apiService.POST('/user/create', {},\n        {\n          credential: {\n            email,\n            password\n          }\n        }\n      ).then(response => {\n        if(response.error) reject(response);\n        if(!response.token) {\n          console.error('[Error][Sheetbase][User] No auth endpoint user/create found in backend!');\n          reject(null);\n        }\n\n        // save data\n        this.ngZone.run(() => {\n          this.userDataService.user = response.user;\n          this.userDataService.token = response.token;\n        });\n\n        localforage.setItem('sheetbaseAuthData', response)\n        .then(() => {return})\n        .catch(error => {return});\n\n        PubSub.publish('SHEETBASE_AUTH_STATE_CHANGED', response);\n        resolve(response);\n      }).catch(reject);\n    });\n  }\n\n  loginWithEmailAndPassword(email: string, password: string) {\n    return new Promise((resolve, reject) => {\n      if(this.userDataService.user) resolve({\n        token: this.userDataService.token,\n        user: this.userDataService.user\n      });\n\n      this.apiService.POST('/user/login', {},\n        {\n          credential: {\n            email,\n            password\n          }\n        }\n      ).then(response => {\n        if(response.error) reject(response);\n        if(!response.token) {\n          console.error('[Error][Sheetbase][User] No auth endpoint user/login found in backend!');\n          reject(null);\n        }\n\n        // save data\n        this.ngZone.run(() => {\n          this.userDataService.user = response.user;\n          this.userDataService.token = response.token;\n        });\n\n        localforage.setItem('sheetbaseAuthData', response)\n        .then(() => {return})\n        .catch(error => {return});\n\n        PubSub.publish('SHEETBASE_AUTH_STATE_CHANGED', response);\n        resolve(response);\n      }).catch(reject);\n    });\n  }\n\n  signOut(): Promise<any> {\n    return new Promise((resolve, reject) => {\n      this.userDataService.user = null;\n      this.userDataService.token = null;\n\n      localforage.removeItem('sheetbaseAuthData')\n      .then(() => {return})\n      .catch(error => {return});\n\n      PubSub.publish('SHEETBASE_AUTH_STATE_CHANGED', null);\n      resolve(null);\n    });\n  }\n\n  updateProfile(profileData: any): Promise<any> {\n    return new Promise((resolve, reject) => {\n      this.apiService.POST('/user/profile', {},\n        {\n          profileData\n        }\n      ).then(response => {\n        if(response.error) reject(response);\n        if(!response.user) {\n          console.error('[Error][Sheetbase][User] No auth endpoint user/profile found in backend!');\n          reject(null);\n        }\n\n        // save data\n        this.ngZone.run(() => {\n          this.userDataService.user = response.user;\n        });\n\n        localforage.setItem('sheetbaseAuthData', {\n          token: this.userDataService.token,\n          user: response.user\n        })\n        .then(() => {return})\n        .catch(error => {return});\n\n        PubSub.publish('SHEETBASE_AUTH_STATE_CHANGED', response);\n        resolve(response.user);\n      }).catch(reject);\n    });\n  }\n\n\n}\n"]}