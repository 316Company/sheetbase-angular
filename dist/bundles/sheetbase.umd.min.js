!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("lodash"),require("@angular/common/http"),require("ionic-angular"),require("rxjs")):"function"==typeof define&&define.amd?define(["exports","@angular/core","lodash","@angular/common/http","ionic-angular","rxjs"],t):t((e.ng=e.ng||{},e.ng.sheetbase={}),e.ng.core,e._,e.ng.common.http,e.ionicAngular,e.Rx)}(this,function(e,n,o,t,a,l){"use strict";var r=new n.InjectionToken("SheetbaseConfig"),c=function(e,t,n,o){void 0===t&&(t=!1),void 0===n&&(n=null),void 0===o&&(o=!1),t&&void 0!==e&&(e=JSON.parse(JSON.stringify(e)));var a=[];for(var r in e)"object"==typeof e[r]?e[r].$key=r:e[r]={$key:r,value:e[r]},a.push(e[r]);return n&&a.splice(n,a.length),o&&a.length<1&&(a=null),a},s=function(e,t,n){return void 0===t&&(t="$key"),void 0===n&&(n="desc"),o.orderBy(e,[t],[n])},i=function(){function e(e,t,n,o){this.ngZone=e,this.http=t,this.events=n,this.CONFIG=o,this.tables=[{name:"categories"},{name:"tags"},{name:"authors"},{name:"posts"},{name:"pages"}]}return e.prototype.db=function(){return{id:this.CONFIG.database,tables:this.tables||[]}},e.prototype.init=function(){var t=this;this.spreadsheetGet({id:this.CONFIG.database,range:"__tables__!A1:C"},null,"name",!1).then(function(e){t.tables=e,t.events.publish("appData:tables",e),t.loadData()}).catch(function(e){t.init()})},e.prototype.get=function(a,r,s,i){var u=this;return void 0===r&&(r=null),void 0===s&&(s=null),void 0===i&&(i=!1),new l.Observable(function(t){u.database=u.database||{};var e=u.database[a]||{};if((!e||Object.keys(e).length<1)&&u.initNonAutoloadTable(a),r)t.next(Object.assign({$key:r},e[r]||{})),i?t.complete():u.events.subscribe("appData:"+a,function(e){t.next(Object.assign({$key:r},e[r]||{}))});else{var n=[];for(var o in e)n.push(Object.assign({$key:o},e[o]));t.next(u.filterResult(n,s)),i?t.complete():u.events.subscribe("appData:"+a,function(e){delete e.$key,t.next(u.filterResult(c(e,!0),s))})}})},e.prototype.api=function(a,r,s,i){var u=this;return void 0===a&&(a="GET"),void 0===r&&(r=null),void 0===s&&(s={}),void 0===i&&(i={}),new Promise(function(t,n){u.CONFIG.backend||n({message:"No backend!"});var e="https://script.google.com/macros/s/"+u.CONFIG.backend+"/exec";for(var o in r&&(e+="?e="+r),!r&&0<Object.keys(s||{}).length&&(e+="?"),s||{})e+="&"+o+"="+s[o];!r&&0<Object.keys(s||{}).length&&(e=e.replace("?&","?")),"post"===a.toLowerCase()?u.http.post(e,JSON.stringify(i),{headers:{"Content-Type":"application/json"}}).subscribe(function(e){e.error&&n(e),t(e)},n):u.http.get(e).subscribe(function(e){e.error&&n(e),t(e)},n)})},e.prototype.initNonAutoloadTable=function(t){var n=this;this.tables?this.loadNonAutoloadTable(t):this.events.subscribe("appData:tables",function(e){n.loadNonAutoloadTable(t)})},e.prototype.loadNonAutoloadTable=function(t){var n=null;if((this.tables||[]).forEach(function(e){e.name===t&&(n=e)}),n)return this.loadData([n])},e.prototype.loadData=function(e){var n=this;void 0===e&&(e=null),(e||this.tables||[]).forEach(function(t){(e||t.autoload)&&(-1<(n.onTheFlyTracker||[]).indexOf(t.name)||(n.onTheFlyTracker=n.onTheFlyTracker||[],n.onTheFlyTracker.push(t.name),setTimeout(function(){n.spreadsheetGet({id:n.CONFIG.database,range:t.name+"!"+(t.range||"A1:ZZ")},t.name,t.key).then(function(e){n.database=n.database||{},n.database[t.name]=e,n.events.publish("appData:"+t.name,e),n.onTheFlyTracker.splice(n.onTheFlyTracker.indexOf("table.name"),1)}).catch(function(e){})},100)))})},e.prototype.filterResult=function(e,n){var o=[];if((n=n||{}).orderByKey&&(n.equalTo||!n.equalTo&&"boolean"==typeof n.equalTo)){var a=n.orderByKey.split("/"),r=a[0];a=a.slice(1,a.length),(e||[]).forEach(function(e){var t=e[r]||{};(a||[]).forEach(function(e){if(!t[e])return t=null;t=t[e]}),("boolean"==typeof n.equalTo&&"boolean"==typeof t&&t===n.equalTo||"!null"===n.equalTo&&t||"boolean"!=typeof n.equalTo&&"boolean"!=typeof t&&t===n.equalTo)&&o.push(e)})}else o=e;return o=s(o,n.orderByKey||"id",n.order||"asc"),n.limitToFirst&&(o=o.slice(n.offset||0,n.limitToFirst+(n.offset||0))),n.limitToLast&&(o=o.slice(o.length-n.limitToLast-(n.offset||0),o.length-(n.offset||0))),o},e.prototype.spreadsheetGet=function(o,a,r,s){var i=this;return void 0===a&&(a=null),void 0===r&&(r=null),void 0===s&&(s=!0),new Promise(function(t,e){if(o.range.indexOf(",")<0)i.spreadsheetLoad(o.id,o.range).then(function(e){return i.ngZone.run(function(){t(i.spreadsheetModifyValue(e,a,r,s))})}).catch(e);else{var n="";(o.range.split(",").map(function(e){return e.trim()})||[]).forEach(function(e){n+="&ranges="+e}),i.spreadsheetLoadBatch(o.id,n).then(function(e){return i.ngZone.run(function(){t(i.spreadsheetModifyValue(e,a,r,s))})}).catch(e)}})},e.prototype.spreadsheetLoad=function(n,o){var a=this;return new Promise(function(t,e){a.http.get("https://sheets.googleapis.com/v4/spreadsheets/"+n+"/values/"+o+"?key="+a.CONFIG.apiKey).subscribe(function(e){t(a.spreadsheetTransformValue(e.values))},e)})},e.prototype.spreadsheetTransformValue=function(e){var a=[],r=e[0]||[];return(e.slice(1,e.length)||[]).forEach(function(e){for(var t={},n=0;n<e.length;n++)if(e[n]){var o=e[n];t[r[n]]=o}a.push(t)}),a},e.prototype.spreadsheetLoadBatch=function(n,o){var a=this;return new Promise(function(t,e){a.http.get("https://sheets.googleapis.com/v4/spreadsheets/"+n+"/values:batchGet?"+o+"&key="+a.CONFIG.apiKey).subscribe(function(e){t(a.spreadsheetTransformBatchValue(e.valueRanges))},e)})},e.prototype.spreadsheetTransformBatchValue=function(e){var t=this,n=this.spreadsheetTransformValue(e[0].values||[]),o=[];(e.slice(1,e.length)||[]).forEach(function(e){o.push(t.spreadsheetTransformValue(e.values||[]))});var a=[];return(n||[]).forEach(function(t){(o||[]).forEach(function(e){(e||[]).forEach(function(e){t.key===e.key&&(t=Object.assign(t,e))})}),a.push(t)}),a},e.prototype.spreadsheetModifyValue=function(e,t,n,o){var a=function(e,t){return void 0===t&&(t={}),e};t&&this.CONFIG.modifiers&&this.CONFIG.modifiers[t]&&(a=this.CONFIG.modifiers[t]);var r=null,s=null;return(e||[]).forEach(function(e){for(var t in e){try{e[t]=JSON.parse(e[t])}catch(e){}isNaN(e[t])||Number(e[t])%1!=0||(e[t]=parseInt(e[t])),isNaN(e[t])||Number(e[t])%1==0||(e[t]=parseFloat(e[t])),("string"==typeof e[t]||e[t]instanceof String)&&(e[t]="true"===e[t].toLowerCase()||"false"!==e[t].toLowerCase()&&e[t]),""!==e[t]&&null!==e[t]&&void 0!==e[t]||delete e[t]}e=a(e,{}),(r=r||{})[n?e[n]:e.key||e.slug||""+e.id]=e,(s=s||[]).push(e)}),o?r:s},e.decorators=[{type:n.Injectable}],e.ctorParameters=function(){return[{type:n.NgZone},{type:t.HttpClient},{type:a.Events},{type:void 0,decorators:[{type:n.Inject,args:[r]}]}]},e}(),u=function(){function t(){}return t.forRoot=function(e){return{ngModule:t,providers:[i,{provide:r,useValue:e}]}},t.decorators=[{type:n.NgModule}],t}();e.SheetbaseModule=u,e.SheetbaseService=i,Object.defineProperty(e,"__esModule",{value:!0})});