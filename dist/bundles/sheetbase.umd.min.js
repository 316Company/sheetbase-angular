!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("rxjs"),require("@angular/common/http"),require("lodash"),require("pubsub-js"),require("localforage")):"function"==typeof define&&define.amd?define(["exports","@angular/core","rxjs","@angular/common/http","lodash","pubsub-js","localforage"],t):t((e.ng=e.ng||{},e.ng.sheetbase={}),e.ng.core,e.rxjs,e.i1,e.lodash,e.PubSub,e.localforage)}(this,function(e,r,s,t,n,o,i){"use strict";var a=new r.InjectionToken("SheetbaseConfig"),u=function(){function e(e,t,r){this.ngZone=e,this.http=t,this.CONFIG=r}return e.prototype.get=function(e,t,r,n){return void 0===t&&(t="A1:ZZ"),void 0===r&&(r=null),void 0===n&&(n=!0),this.getData(this.CONFIG.databaseId,e+"!"+t,e,r,n)},e.prototype.getData=function(e,n,o,i,a){var u=this;return new s.Observable(function(t){if(n.indexOf(",")<0)u.load(e,n).subscribe(function(e){return u.ngZone.run(function(){t.next(u.modifyValue(e,o,i,a))})},function(e){return t.error(e)});else{var r="";(n.split(",").map(function(e){return e.trim()})||[]).forEach(function(e){r+="&ranges="+e}),u.loadBatch(e,r).subscribe(function(e){return u.ngZone.run(function(){t.next(u.modifyValue(e,o,i,a))})},function(e){return t.error(e)})}})},e.prototype.load=function(e,r){var n=this;return new s.Observable(function(t){n.http.get("https://sheets.googleapis.com/v4/spreadsheets/"+e+"/values/"+r+"?key="+n.CONFIG.googleApiKey).subscribe(function(e){t.next(n.transformValue(e.values))},function(e){return t.error(e)})})},e.prototype.transformValue=function(e){var o=[],i=e[0]||[];return(e.slice(1,e.length)||[]).forEach(function(e){for(var t={},r=0;r<e.length;r++)if(e[r]){var n=e[r];t[i[r]]=n}o.push(t)}),o},e.prototype.loadBatch=function(e,r){var n=this;return new s.Observable(function(t){n.http.get("https://sheets.googleapis.com/v4/spreadsheets/"+e+"/values:batchGet?"+r+"&key="+n.CONFIG.googleApiKey).subscribe(function(e){t.next(n.transformBatchValue(e.valueRanges))},function(e){return t.error(e)})})},e.prototype.transformBatchValue=function(e){var t=this,r=this.transformValue(e[0].values||[]),n=[];(e.slice(1,e.length)||[]).forEach(function(e){n.push(t.transformValue(e.values||[]))});var o=[];return(r||[]).forEach(function(t){(n||[]).forEach(function(e){(e||[]).forEach(function(e){t.key===e.key&&(t=Object.assign(t,e))})}),o.push(t)}),o},e.prototype.modifyValue=function(e,t,r,n){var o=function(e,t){return void 0===t&&(t={}),e};t&&this.CONFIG.modifiers&&this.CONFIG.modifiers[t]&&(o=this.CONFIG.modifiers[t]);var i=null,a=null;return(e||[]).forEach(function(e){for(var t in e){try{e[t]=JSON.parse(e[t])}catch(e){}isNaN(e[t])||Number(e[t])%1!=0||(e[t]=parseInt(e[t])),isNaN(e[t])||Number(e[t])%1==0||(e[t]=parseFloat(e[t])),("string"==typeof e[t]||e[t]instanceof String)&&(e[t]="true"===e[t].toLowerCase()||"false"!==e[t].toLowerCase()&&e[t]),""!==e[t]&&null!==e[t]&&void 0!==e[t]||delete e[t]}e=o(e,{}),(i=i||{})[r?e[r]:e.key||e.slug||""+e.id||""+e["#"]||""+1e20*Math.random()]=e,(a=a||[]).push(e)}),n?i:a},e.decorators=[{type:r.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:r.NgZone},{type:t.HttpClient},{type:void 0,decorators:[{type:r.Inject,args:[a]}]}]},e.ngInjectableDef=r.defineInjectable({factory:function(){return new e(r.inject(r.NgZone),r.inject(t.HttpClient),r.inject(a))},token:e,providedIn:"root"}),e}(),c=function(){function e(){}return e.decorators=[{type:r.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[]},e.ngInjectableDef=r.defineInjectable({factory:function(){return new e},token:e,providedIn:"root"}),e}(),f=function(){function e(e,t,r){this.http=e,this.CONFIG=t,this.userDataService=r}return e.prototype.GET=function(n,o){var i=this;return void 0===n&&(n=null),void 0===o&&(o={}),new s.Observable(function(t){if(!i.CONFIG.backendUrl)return t.error("[Error][Sheetbase] No backend for this project!");var e=i.CONFIG.backendUrl;for(var r in n&&(e+="?e="+n),!n&&0<Object.keys(o||{}).length&&(e+="?"),o||{})e+="&"+r+"="+o[r];!n&&0<Object.keys(o||{}).length&&(e=e.replace("?&","?")),!n&&Object.keys(o).length<1?e+="?apiKey="+i.CONFIG.apiKey:e+="&apiKey="+i.CONFIG.apiKey,i.userDataService.token&&(e+="&token="+i.userDataService.token),i.http.get(e).subscribe(function(e){if(e.error)return t.error(e);t.next(e)},function(e){return t.error(e)})})},e.prototype.POST=function(n,o,i){var a=this;return void 0===n&&(n=null),void 0===o&&(o={}),void 0===i&&(i={}),new s.Observable(function(t){if(!a.CONFIG.backendUrl)return t.error("[Error][Sheetbase] No backend for this project!");var e=a.CONFIG.backendUrl;for(var r in n&&(e+="?e="+n),!n&&0<Object.keys(o||{}).length&&(e+="?"),o||{})e+="&"+r+"="+o[r];!n&&0<Object.keys(o||{}).length&&(e=e.replace("?&","?")),i=Object.assign({},i,{apiKey:a.CONFIG.apiKey}),a.userDataService.token&&(i.token=a.userDataService.token),a.http.post(e,JSON.stringify(i),{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).subscribe(function(e){if(e.error)return t.error(e);t.next(e)},function(e){return t.error(e)})})},e.decorators=[{type:r.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:t.HttpClient},{type:void 0,decorators:[{type:r.Inject,args:[a]}]},{type:c}]},e.ngInjectableDef=r.defineInjectable({factory:function(){return new e(r.inject(t.HttpClient),r.inject(a),r.inject(c))},token:e,providedIn:"root"}),e}(),l=function(e,t,r){return void 0===t&&(t="$key"),void 0===r&&(r="desc"),n.orderBy(e,[t],[r])},p=function(){function e(e,t,r){this.CONFIG=e,this.apiService=t,this.spreadsheetService=r}return e.prototype.get=function(n,o,i){var a=this;return void 0===o&&(o=null),void 0===i&&(i=null),new s.Observable(function(t){var e=(a.database||{})[n];if(e&&0<Object.keys(e).length)t.next(a.returnData(n,o,i)),t.complete();else{var r=a.getData(n,o,i);a.CONFIG.googleApiKey&&a.CONFIG.databaseId&&(r=a.getDataSolutionLite(n,o,i)),r.subscribe(function(e){a.database||(a.database={}),a.database[n]=e,t.next(a.returnData(n,o,i)),t.complete()},function(e){return t.error(e)})}})},e.prototype.getData=function(r,e,t){var n=this;return new s.Observable(function(t){n.apiService.GET("/data",{table:r}).subscribe(function(e){t.next(n.modifyValue(e.data,r))},function(e){return t.error(e)})})},e.prototype.getDataSolutionLite=function(e,t,r){var n=this;return new s.Observable(function(t){n.spreadsheetService.get(e).subscribe(function(e){t.next(e)},function(e){return t.error(e)})})},e.prototype.returnData=function(e,t,r){var n=(this.database||{})[e]||{};if(t)return Object.assign({$key:t},n[t]||{});var o=[];for(var i in n)o.push(Object.assign({$key:i},n[i]));return this.filterResult(o,r)},e.prototype.filterResult=function(e,r){var n=[];if((r=r||{}).orderByKey&&(r.equalTo||!r.equalTo&&"boolean"==typeof r.equalTo)){var o=r.orderByKey.split("/"),i=o[0];o=o.slice(1,o.length),(e||[]).forEach(function(e){var t=e[i]||{};(o||[]).forEach(function(e){if(!t[e])return t=null;t=t[e]}),("boolean"==typeof r.equalTo&&"boolean"==typeof t&&t===r.equalTo||"!null"===r.equalTo&&t||"boolean"!=typeof r.equalTo&&"boolean"!=typeof t&&t===r.equalTo)&&n.push(e)})}else n=e;return n=l(n,r.orderByKey||"id",r.order||"asc"),r.limitToFirst&&(n=n.slice(r.offset||0,r.limitToFirst+(r.offset||0))),r.limitToLast&&(n=n.slice(n.length-r.limitToLast-(r.offset||0),n.length-(r.offset||0))),n},e.prototype.modifyValue=function(e,t){var r=function(e,t){return void 0===t&&(t={}),e};t&&this.CONFIG.modifiers&&this.CONFIG.modifiers[t]&&(r=this.CONFIG.modifiers[t]);var n={};for(var o in e){var i=e[o];i=r(i,{}),n[o]=i}return n},e.decorators=[{type:r.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:void 0,decorators:[{type:r.Inject,args:[a]}]},{type:f},{type:u}]},e.ngInjectableDef=r.defineInjectable({factory:function(){return new e(r.inject(a),r.inject(f),r.inject(u))},token:e,providedIn:"root"}),e}(),d=function(){function e(e,t,r){this.ngZone=e,this.userDataService=t,this.apiService=r}return e.prototype.getToken=function(){return this.userDataService.token},e.prototype.getUser=function(){return this.userDataService.user},e.prototype.onAuthStateChanged=function(){var t=this;return new s.Observable(function(r){i.getItem("sheetbaseAuthData").then(function(e){t.ngZone.run(function(){t.userDataService.user=e.user,t.userDataService.token=e.token}),r.next(e?e.user:null)}).catch(function(e){r.next(null)}),o.subscribe("SHEETBASE_AUTH_STATE_CHANGED",function(e,t){r.next(t?t.user:null)})})},e.prototype.createUserWithEmailAndPassword=function(e,r){var n=this;return new s.Observable(function(t){if(!e||!r)return t.error("Missing email or password!");n.apiService.POST("/user/create",{},{credential:{email:e,password:r}}).subscribe(function(e){if(e.error)return t.error(e);n.ngZone.run(function(){n.userDataService.user=e.data.user,n.userDataService.token=e.data.token}),i.setItem("sheetbaseAuthData",e.data).then(function(){}).catch(function(e){}),o.publish("SHEETBASE_AUTH_STATE_CHANGED",e.data),t.next(e)},function(e){return t.error(e)})})},e.prototype.signInWithEmailAndPassword=function(e,r){var n=this;return new s.Observable(function(t){if(!e||!r)return t.error("Missing email or password!");n.userDataService.user&&t.next({token:n.userDataService.token,user:n.userDataService.user}),n.apiService.POST("/user/login",{},{credential:{email:e,password:r}}).subscribe(function(e){if(e.error)return t.error(e);n.ngZone.run(function(){n.userDataService.user=e.data.user,n.userDataService.token=e.data.token}),i.setItem("sheetbaseAuthData",e.data).then(function(){}).catch(function(e){}),o.publish("SHEETBASE_AUTH_STATE_CHANGED",e.data),t.next(e)},function(e){return t.error(e)})})},e.prototype.signOut=function(){var t=this;return new s.Observable(function(e){t.userDataService.user=null,t.userDataService.token=null,i.removeItem("sheetbaseAuthData").then(function(){}).catch(function(e){}),o.publish("SHEETBASE_AUTH_STATE_CHANGED",null),e.next(null)})},e.prototype.updateProfile=function(e){var r=this;return new s.Observable(function(t){return e&&e instanceof Object?r.userDataService.user&&r.userDataService.token?void r.apiService.POST("/user/profile",{},{profile:e}).subscribe(function(e){if(e.error)return t.error(e);r.ngZone.run(function(){r.userDataService.user=e.data.user}),i.setItem("sheetbaseAuthData",{token:r.userDataService.token,user:e.data.user}).then(function(){}).catch(function(e){}),o.publish("SHEETBASE_AUTH_STATE_CHANGED",e.data),t.next(e.data.user)},function(e){return t.error(e)}):t.error("Please login first!"):t.error("Invalid profile data.")})},e.prototype.sendPasswordResetEmail=function(e){var r=this;return new s.Observable(function(t){if(!e)return t.error("Missing email!");r.apiService.POST("/auth/reset-password",{},{email:e}).subscribe(function(e){if(e.error)return t.error(e);t.next(e)},function(e){return t.error(e)})})},e.prototype.confirmPasswordReset=function(e,r){var n=this;return new s.Observable(function(t){if(!e||!r)return t.error("Missing actionCode or password!");n.apiService.POST("/auth/set-password",{},{code:e,newPassword:r}).subscribe(function(e){if(e.error)return t.error(e);t.next(e)},function(e){return t.error(e)})})},e.prototype.applyActionCode=function(e){var r=this;return new s.Observable(function(t){if(!e)return t.error("Missing actionCode!");r.apiService.POST("/auth/verify-code",{},{code:e}).subscribe(function(e){if(e.error)return t.error(e);t.next(e)},function(e){return t.error(e)})})},e.decorators=[{type:r.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:r.NgZone},{type:c},{type:f}]},e.ngInjectableDef=r.defineInjectable({factory:function(){return new e(r.inject(r.NgZone),r.inject(c),r.inject(f))},token:e,providedIn:"root"}),e}(),v=function(){function e(e,t){this.ngZone=e,this.apiService=t}return e.prototype.get=function(e){return this.apiService.GET("/file",{id:e})},e.prototype.upload=function(r,n,o){var i=this;return void 0===n&&(n=null),void 0===o&&(o=null),new s.Observable(function(t){if(!r)return t.error("No local file!");var e={file:Object.assign(i.base64Breakdown(r.base64),{name:r.name})};n&&(e.folder=n),o&&(e.name=o),i.apiService.POST("/file",{},e).subscribe(function(e){t.next(e)},function(e){return t.error(e)})})},e.prototype.load=function(r){return new s.Observable(function(t){if(!r)return t.error(null);var e=new FileReader;e.onload=function(e){t.next({name:r.name,size:r.size,mimeType:r.type,base64:e.target.result})},e.readAsDataURL(r)})},e.prototype.base64Breakdown=function(e){var t=e.split(";base64,");return{mimeType:t[0].replace("data:",""),base64String:t[1]}},e.decorators=[{type:r.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:r.NgZone},{type:f}]},e.ngInjectableDef=r.defineInjectable({factory:function(){return new e(r.inject(r.NgZone),r.inject(f))},token:e,providedIn:"root"}),e}(),b=function(){function t(){}return t.forRoot=function(e){return{ngModule:t,providers:[{provide:a,useValue:e},u,p,f,d,c,v]}},t.decorators=[{type:r.NgModule}],t}();e.SheetbaseModule=b,e.SpreadsheetService=u,e.DataService=p,e.ApiService=f,e.UserService=d,e.FileService=v,Object.defineProperty(e,"__esModule",{value:!0})});