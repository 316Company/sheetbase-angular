!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("@angular/core"),require("rxjs/Observable"),require("@angular/common/http"),require("lodash"),require("pubsub-js"),require("localforage")):"function"==typeof define&&define.amd?define(["exports","@angular/core","rxjs/Observable","@angular/common/http","lodash","pubsub-js","localforage"],r):r((e.ng=e.ng||{},e.ng.sheetbase={}),e.ng.core,e.Rx,e.http,e.lodash,e.PubSub,e.localforage)}(this,function(e,t,s,r,n,o,i){"use strict";var a=new t.InjectionToken("SheetbaseConfig"),u=function(){function e(e,r,t){this.ngZone=e,this.http=r,this.CONFIG=t}return e.prototype.get=function(e,r,t,n){return void 0===r&&(r="A1:ZZ"),void 0===t&&(t=null),void 0===n&&(n=!0),this.getData(this.CONFIG.databaseId,e+"!"+r,e,t,n)},e.prototype.getData=function(e,n,o,i,a){var u=this;return new s.Observable(function(r){if(n.indexOf(",")<0)u.load(e,n).subscribe(function(e){return u.ngZone.run(function(){r.next(u.modifyValue(e,o,i,a))})},function(e){return r.error(e)});else{var t="";(n.split(",").map(function(e){return e.trim()})||[]).forEach(function(e){t+="&ranges="+e}),u.loadBatch(e,t).subscribe(function(e){return u.ngZone.run(function(){r.next(u.modifyValue(e,o,i,a))})},function(e){return r.error(e)})}})},e.prototype.load=function(e,t){var n=this;return new s.Observable(function(r){n.http.get("https://sheets.googleapis.com/v4/spreadsheets/"+e+"/values/"+t+"?key="+n.CONFIG.googleApiKey).subscribe(function(e){r.next(n.transformValue(e.values))},function(e){return r.error(e)})})},e.prototype.transformValue=function(e){var o=[],i=e[0]||[];return(e.slice(1,e.length)||[]).forEach(function(e){for(var r={},t=0;t<e.length;t++)if(e[t]){var n=e[t];r[i[t]]=n}o.push(r)}),o},e.prototype.loadBatch=function(e,t){var n=this;return new s.Observable(function(r){n.http.get("https://sheets.googleapis.com/v4/spreadsheets/"+e+"/values:batchGet?"+t+"&key="+n.CONFIG.googleApiKey).subscribe(function(e){r.next(n.transformBatchValue(e.valueRanges))},function(e){return r.error(e)})})},e.prototype.transformBatchValue=function(e){var r=this,t=this.transformValue(e[0].values||[]),n=[];(e.slice(1,e.length)||[]).forEach(function(e){n.push(r.transformValue(e.values||[]))});var o=[];return(t||[]).forEach(function(r){(n||[]).forEach(function(e){(e||[]).forEach(function(e){r.key===e.key&&(r=Object.assign(r,e))})}),o.push(r)}),o},e.prototype.modifyValue=function(e,r,t,n){var o=function(e,r){return void 0===r&&(r={}),e};r&&this.CONFIG.modifiers&&this.CONFIG.modifiers[r]&&(o=this.CONFIG.modifiers[r]);var i=null,a=null;return(e||[]).forEach(function(e){for(var r in e){try{e[r]=JSON.parse(e[r])}catch(e){}isNaN(e[r])||Number(e[r])%1!=0||(e[r]=parseInt(e[r])),isNaN(e[r])||Number(e[r])%1==0||(e[r]=parseFloat(e[r])),("string"==typeof e[r]||e[r]instanceof String)&&(e[r]="true"===e[r].toLowerCase()||"false"!==e[r].toLowerCase()&&e[r]),""!==e[r]&&null!==e[r]&&void 0!==e[r]||delete e[r]}e=o(e,{}),(i=i||{})[t?e[t]:e.key||e.slug||""+e.id||""+e["#"]||""+1e20*Math.random()]=e,(a=a||[]).push(e)}),n?i:a},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:t.NgZone},{type:r.HttpClient},{type:void 0,decorators:[{type:t.Inject,args:[a]}]}]},e}(),c=function(){function e(){}return e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[]},e}(),f=function(){function e(e,r,t){this.http=e,this.CONFIG=r,this.userDataService=t}return e.prototype.GET=function(n,o){var i=this;return void 0===n&&(n=null),void 0===o&&(o={}),new s.Observable(function(r){if(!i.CONFIG.backendUrl)return r.error("[Error][Sheetbase] No backend for this project!");var e=i.CONFIG.backendUrl;for(var t in n&&(e+="?e="+n),!n&&0<Object.keys(o||{}).length&&(e+="?"),o||{})e+="&"+t+"="+o[t];!n&&0<Object.keys(o||{}).length&&(e=e.replace("?&","?")),!n&&Object.keys(o).length<1?e+="?apiKey="+i.CONFIG.apiKey:e+="&apiKey="+i.CONFIG.apiKey,i.userDataService.token&&(e+="&token="+i.userDataService.token),i.http.get(e).subscribe(function(e){if(e.error)return r.error(e);r.next(e)},function(e){return r.error(e)})})},e.prototype.POST=function(n,o,i){var a=this;return void 0===n&&(n=null),void 0===o&&(o={}),void 0===i&&(i={}),new s.Observable(function(r){if(!a.CONFIG.backendUrl)return r.error("[Error][Sheetbase] No backend for this project!");var e=a.CONFIG.backendUrl;for(var t in n&&(e+="?e="+n),!n&&0<Object.keys(o||{}).length&&(e+="?"),o||{})e+="&"+t+"="+o[t];!n&&0<Object.keys(o||{}).length&&(e=e.replace("?&","?")),i=Object.assign({},i,{apiKey:a.CONFIG.apiKey}),a.userDataService.token&&(i.token=a.userDataService.token),a.http.post(e,JSON.stringify(i),{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).subscribe(function(e){if(e.error)return r.error(e);r.next(e)},function(e){return r.error(e)})})},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:r.HttpClient},{type:void 0,decorators:[{type:t.Inject,args:[a]}]},{type:c}]},e}(),l=function(e,r,t){return void 0===r&&(r="$key"),void 0===t&&(t="desc"),n.orderBy(e,[r],[t])},p=function(){function e(e,r,t,n){this.ngZone=e,this.CONFIG=r,this.apiService=t,this.spreadsheetService=n}return e.prototype.get=function(n,o,i){var a=this;return void 0===o&&(o=null),void 0===i&&(i=null),new s.Observable(function(r){var e=(a.database||{})[n];e&&0<Object.keys(e).length&&r.next(a.returnData(n,o,i));var t=a.getData(n,o,i);a.CONFIG.googleApiKey&&a.CONFIG.databaseId&&(t=a.getDataSolutionLite(n,o,i)),t.subscribe(function(e){a.ngZone.run(function(){a.database||(a.database={}),a.database[n]=e}),r.next(a.returnData(n,o,i))},function(e){return r.error(e)})})},e.prototype.getData=function(t,e,r){var n=this;return new s.Observable(function(r){n.apiService.GET("/data",{table:t}).subscribe(function(e){r.next(n.modifyValue(e.data,t))},function(e){return r.error(e)})})},e.prototype.getDataSolutionLite=function(e,r,t){var n=this;return new s.Observable(function(r){n.spreadsheetService.get(e).subscribe(function(e){r.next(e)},function(e){return r.error(e)})})},e.prototype.returnData=function(e,r,t){var n=(this.database||{})[e]||{};if(r)return Object.assign({$key:r},n[r]||{});var o=[];for(var i in n)o.push(Object.assign({$key:i},n[i]));return this.filterResult(o,t)},e.prototype.filterResult=function(e,t){var n=[];if((t=t||{}).orderByKey&&(t.equalTo||!t.equalTo&&"boolean"==typeof t.equalTo)){var o=t.orderByKey.split("/"),i=o[0];o=o.slice(1,o.length),(e||[]).forEach(function(e){var r=e[i]||{};(o||[]).forEach(function(e){if(!r[e])return r=null;r=r[e]}),("boolean"==typeof t.equalTo&&"boolean"==typeof r&&r===t.equalTo||"!null"===t.equalTo&&r||"boolean"!=typeof t.equalTo&&"boolean"!=typeof r&&r===t.equalTo)&&n.push(e)})}else n=e;return n=l(n,t.orderByKey||"id",t.order||"asc"),t.limitToFirst&&(n=n.slice(t.offset||0,t.limitToFirst+(t.offset||0))),t.limitToLast&&(n=n.slice(n.length-t.limitToLast-(t.offset||0),n.length-(t.offset||0))),n},e.prototype.modifyValue=function(e,r){var t=function(e,r){return void 0===r&&(r={}),e};r&&this.CONFIG.modifiers&&this.CONFIG.modifiers[r]&&(t=this.CONFIG.modifiers[r]);var n={};for(var o in e){var i=e[o];i=t(i,{}),n[o]=i}return n},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:t.NgZone},{type:void 0,decorators:[{type:t.Inject,args:[a]}]},{type:f},{type:u}]},e}(),d=function(){function e(e,r,t){this.ngZone=e,this.userDataService=r,this.apiService=t}return e.prototype.getToken=function(){return this.userDataService.token},e.prototype.getUser=function(){return this.userDataService.user},e.prototype.onAuthStateChanged=function(){var r=this;return new s.Observable(function(t){i.getItem("sheetbaseAuthData").then(function(e){r.ngZone.run(function(){r.userDataService.user=e.user,r.userDataService.token=e.token}),t.next(e?e.user:null)}).catch(function(e){t.next(null)}),o.subscribe("SHEETBASE_AUTH_STATE_CHANGED",function(e,r){t.next(r?r.user:null)})})},e.prototype.createUserWithEmailAndPassword=function(e,t){var n=this;return new s.Observable(function(r){if(!e||!t)return r.error("Missing email or password!");n.apiService.POST("/user/create",{},{credential:{email:e,password:t}}).subscribe(function(e){if(e.error)return r.error(e);n.ngZone.run(function(){n.userDataService.user=e.data.user,n.userDataService.token=e.data.token}),i.setItem("sheetbaseAuthData",e.data).then(function(){}).catch(function(e){}),o.publish("SHEETBASE_AUTH_STATE_CHANGED",e.data),r.next(e)},function(e){return r.error(e)})})},e.prototype.signInWithEmailAndPassword=function(e,t){var n=this;return new s.Observable(function(r){if(!e||!t)return r.error("Missing email or password!");n.userDataService.user&&r.next({token:n.userDataService.token,user:n.userDataService.user}),n.apiService.POST("/user/login",{},{credential:{email:e,password:t}}).subscribe(function(e){if(e.error)return r.error(e);n.ngZone.run(function(){n.userDataService.user=e.data.user,n.userDataService.token=e.data.token}),i.setItem("sheetbaseAuthData",e.data).then(function(){}).catch(function(e){}),o.publish("SHEETBASE_AUTH_STATE_CHANGED",e.data),r.next(e)},function(e){return r.error(e)})})},e.prototype.signOut=function(){var r=this;return new s.Observable(function(e){r.userDataService.user=null,r.userDataService.token=null,i.removeItem("sheetbaseAuthData").then(function(){}).catch(function(e){}),o.publish("SHEETBASE_AUTH_STATE_CHANGED",null),e.next(null)})},e.prototype.updateProfile=function(e){var t=this;return new s.Observable(function(r){return e&&e instanceof Object?t.userDataService.user&&t.userDataService.token?void t.apiService.POST("/user/profile",{},{profile:e}).subscribe(function(e){if(e.error)return r.error(e);t.ngZone.run(function(){t.userDataService.user=e.data.user}),i.setItem("sheetbaseAuthData",{token:t.userDataService.token,user:e.data.user}).then(function(){}).catch(function(e){}),o.publish("SHEETBASE_AUTH_STATE_CHANGED",e.data),r.next(e.data.user)},function(e){return r.error(e)}):r.error("Please login first!"):r.error("Invalid profile data.")})},e.prototype.sendPasswordResetEmail=function(e){var t=this;return new s.Observable(function(r){if(!e)return r.error("Missing email!");t.apiService.POST("/auth/reset-password",{},{email:e}).subscribe(function(e){if(e.error)return r.error(e);r.next(e)},function(e){return r.error(e)})})},e.prototype.confirmPasswordReset=function(e,t){var n=this;return new s.Observable(function(r){if(!e||!t)return r.error("Missing actionCode or password!");n.apiService.POST("/auth/set-password",{},{code:e,newPassword:t}).subscribe(function(e){if(e.error)return r.error(e);r.next(e)},function(e){return r.error(e)})})},e.prototype.applyActionCode=function(e){var t=this;return new s.Observable(function(r){if(!e)return r.error("Missing actionCode!");t.apiService.POST("/auth/verify-code",{},{code:e}).subscribe(function(e){if(e.error)return r.error(e);r.next(e)},function(e){return r.error(e)})})},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:t.NgZone},{type:c},{type:f}]},e}(),v=function(){function e(e,r){this.ngZone=e,this.apiService=r}return e.prototype.get=function(e){return this.apiService.GET("/file",{id:e})},e.prototype.upload=function(t,n,o){var i=this;return void 0===n&&(n=null),void 0===o&&(o=null),new s.Observable(function(r){if(!t)return r.error("No local file!");var e={file:Object.assign(i.base64Breakdown(t.base64),{name:t.name})};n&&(e.folder=n),o&&(e.name=o),i.apiService.POST("/file",{},e).subscribe(function(e){r.next(e)},function(e){return r.error(e)})})},e.prototype.load=function(t){return new s.Observable(function(r){if(!t)return r.error(null);var e=new FileReader;e.onload=function(e){r.next({name:t.name,size:t.size,mimeType:t.type,base64:e.target.result})},e.readAsDataURL(t)})},e.prototype.base64Breakdown=function(e){var r=e.split(";base64,");return{mimeType:r[0].replace("data:",""),base64String:r[1]}},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:t.NgZone},{type:f}]},e}(),b=function(){function r(){}return r.forRoot=function(e){return{ngModule:r,providers:[{provide:a,useValue:e},u,p,f,d,c,v]}},r.decorators=[{type:t.NgModule}],r}();e.SheetbaseModule=b,e.SpreadsheetService=u,e.DataService=p,e.ApiService=f,e.UserService=d,e.FileService=v,Object.defineProperty(e,"__esModule",{value:!0})});