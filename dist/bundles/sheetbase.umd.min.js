!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@angular/common/http"),require("lodash"),require("rxjs"),require("pubsub-js"),require("localforage")):"function"==typeof define&&define.amd?define(["exports","@angular/core","@angular/common/http","lodash","rxjs","pubsub-js","localforage"],t):t((e.ng=e.ng||{},e.ng.sheetbase={}),e.ng.core,e.http,e.lodash,e.rxjs,e.PubSub,e.localforage)}(this,function(e,r,t,n,a,i,u){"use strict";var o=new r.InjectionToken("SheetbaseConfig"),s=function(){function e(e,t,r){this.ngZone=e,this.http=t,this.CONFIG=r}return e.prototype.get=function(n,o,i,a,u){var s=this;return void 0===i&&(i=null),void 0===a&&(a=null),void 0===u&&(u=!0),new Promise(function(t,e){if(o.indexOf(",")<0)s.load(n,o).then(function(e){return s.ngZone.run(function(){t(s.modifyValue(e,i,a,u))})}).catch(e);else{var r="";(o.split(",").map(function(e){return e.trim()})||[]).forEach(function(e){r+="&ranges="+e}),s.loadBatch(n,r).then(function(e){return s.ngZone.run(function(){t(s.modifyValue(e,i,a,u))})}).catch(e)}})},e.prototype.load=function(r,n){var o=this;return new Promise(function(t,e){o.http.get("https://sheets.googleapis.com/v4/spreadsheets/"+r+"/values/"+n+"?key="+o.CONFIG.googleApiKey).subscribe(function(e){t(o.transformValue(e.values))},e)})},e.prototype.transformValue=function(e){var o=[],i=e[0]||[];return(e.slice(1,e.length)||[]).forEach(function(e){for(var t={},r=0;r<e.length;r++)if(e[r]){var n=e[r];t[i[r]]=n}o.push(t)}),o},e.prototype.loadBatch=function(r,n){var o=this;return new Promise(function(t,e){o.http.get("https://sheets.googleapis.com/v4/spreadsheets/"+r+"/values:batchGet?"+n+"&key="+o.CONFIG.googleApiKey).subscribe(function(e){t(o.transformBatchValue(e.valueRanges))},e)})},e.prototype.transformBatchValue=function(e){var t=this,r=this.transformValue(e[0].values||[]),n=[];(e.slice(1,e.length)||[]).forEach(function(e){n.push(t.transformValue(e.values||[]))});var o=[];return(r||[]).forEach(function(t){(n||[]).forEach(function(e){(e||[]).forEach(function(e){t.key===e.key&&(t=Object.assign(t,e))})}),o.push(t)}),o},e.prototype.modifyValue=function(e,t,r,n){var o=function(e,t){return void 0===t&&(t={}),e};t&&this.CONFIG.modifiers&&this.CONFIG.modifiers[t]&&(o=this.CONFIG.modifiers[t]);var i=null,a=null;return(e||[]).forEach(function(e){for(var t in e){try{e[t]=JSON.parse(e[t])}catch(e){}isNaN(e[t])||Number(e[t])%1!=0||(e[t]=parseInt(e[t])),isNaN(e[t])||Number(e[t])%1==0||(e[t]=parseFloat(e[t])),("string"==typeof e[t]||e[t]instanceof String)&&(e[t]="true"===e[t].toLowerCase()||"false"!==e[t].toLowerCase()&&e[t]),""!==e[t]&&null!==e[t]&&void 0!==e[t]||delete e[t]}e=o(e,{}),(i=i||{})[r?e[r]:e.key||e.slug||""+e.id||""+e["#"]||""+1e20*Math.random()]=e,(a=a||[]).push(e)}),n?i:a},e.decorators=[{type:r.Injectable}],e.ctorParameters=function(){return[{type:r.NgZone},{type:t.HttpClient},{type:void 0,decorators:[{type:r.Inject,args:[o]}]}]},e}(),c=function(){function e(){}return e.decorators=[{type:r.Injectable}],e.ctorParameters=function(){return[]},e}(),l=function(){function e(e,t,r){this.http=e,this.CONFIG=t,this.userDataService=r}return e.prototype.GET=function(o,i){var a=this;return void 0===o&&(o=null),void 0===i&&(i={}),new Promise(function(t,r){a.CONFIG.backend||(console.error("[Error][Sheetbase] No backend for this project!"),r(null));var e="https://script.google.com/macros/s/"+a.CONFIG.backend+"/exec";for(var n in o&&(e+="?e="+o),!o&&0<Object.keys(i||{}).length&&(e+="?"),i||{})e+="&"+n+"="+i[n];!o&&0<Object.keys(i||{}).length&&(e=e.replace("?&","?")),!o&&Object.keys(i).length<1?e+="?apiKey="+a.CONFIG.apiKey:e+="&apiKey="+a.CONFIG.apiKey,a.userDataService.token&&(e+="&token="+a.userDataService.token),a.http.get(e).subscribe(function(e){e.error&&r(e),t(e)},r)})},e.prototype.POST=function(o,i,a){var u=this;return void 0===o&&(o=null),void 0===i&&(i={}),void 0===a&&(a={}),new Promise(function(t,r){u.CONFIG.backend||(console.error("[Error][Sheetbase] No backend for this project!"),r(null));var e="https://script.google.com/macros/s/"+u.CONFIG.backend+"/exec";for(var n in o&&(e+="?e="+o),!o&&0<Object.keys(i||{}).length&&(e+="?"),i||{})e+="&"+n+"="+i[n];!o&&0<Object.keys(i||{}).length&&(e=e.replace("?&","?")),a=Object.assign({},a,{apiKey:u.CONFIG.apiKey}),u.userDataService.token&&(a.token=u.userDataService.token),u.http.post(e,JSON.stringify(a),{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).subscribe(function(e){e.error&&r(e),t(e)},r)})},e.decorators=[{type:r.Injectable}],e.ctorParameters=function(){return[{type:t.HttpClient},{type:void 0,decorators:[{type:r.Inject,args:[o]}]},{type:c}]},e}(),f=function(e,t,r){return void 0===t&&(t="$key"),void 0===r&&(r="desc"),n.orderBy(e,[t],[r])},p=function(){function e(e,t,r){this.ngZone=e,this.CONFIG=t,this.apiService=r}return e.prototype.get=function(r,n,o){var i=this;return void 0===n&&(n=null),void 0===o&&(o=null),new a.Observable(function(t){var e=(i.database||{})[r];e&&Object.keys(e).length<1&&(t.next(i.returnData(r,n,o)),t.complete()),i.apiService.GET("/data",{table:r}).then(function(e){i.ngZone.run(function(){i.database||(i.database={}),i.database[r]=i.modifyValue(e,r)}),t.next(i.returnData(r,n,o)),t.complete()}).catch(function(e){})})},e.prototype.returnData=function(e,t,r){var n=(this.database||{})[e]||{};if(t)return Object.assign({$key:t},n[t]||{});var o=[];for(var i in n)o.push(Object.assign({$key:i},n[i]));return this.filterResult(o,r)},e.prototype.filterResult=function(e,r){var n=[];if((r=r||{}).orderByKey&&(r.equalTo||!r.equalTo&&"boolean"==typeof r.equalTo)){var o=r.orderByKey.split("/"),i=o[0];o=o.slice(1,o.length),(e||[]).forEach(function(e){var t=e[i]||{};(o||[]).forEach(function(e){if(!t[e])return t=null;t=t[e]}),("boolean"==typeof r.equalTo&&"boolean"==typeof t&&t===r.equalTo||"!null"===r.equalTo&&t||"boolean"!=typeof r.equalTo&&"boolean"!=typeof t&&t===r.equalTo)&&n.push(e)})}else n=e;return n=f(n,r.orderByKey||"id",r.order||"asc"),r.limitToFirst&&(n=n.slice(r.offset||0,r.limitToFirst+(r.offset||0))),r.limitToLast&&(n=n.slice(n.length-r.limitToLast-(r.offset||0),n.length-(r.offset||0))),n},e.prototype.modifyValue=function(e,t){var r=function(e,t){return void 0===t&&(t={}),e};t&&this.CONFIG.modifiers&&this.CONFIG.modifiers[t]&&(r=this.CONFIG.modifiers[t]);var n={};for(var o in e){var i=e[o];i=r(i,{}),n[o]=i}return n},e.decorators=[{type:r.Injectable}],e.ctorParameters=function(){return[{type:r.NgZone},{type:void 0,decorators:[{type:r.Inject,args:[o]}]},{type:l}]},e}(),h=function(){function e(e,t,r){this.ngZone=e,this.userDataService=t,this.apiService=r}return e.prototype.getToken=function(){return this.userDataService.token},e.prototype.getUser=function(){return this.userDataService.user},e.prototype.onAuthStateChanged=function(){var t=this;return new a.Observable(function(r){u.getItem("sheetbaseAuthData").then(function(e){t.ngZone.run(function(){t.userDataService.user=e.user,t.userDataService.token=e.token}),r.next(e?e.user:null)}).catch(function(e){r.next(null)}),i.subscribe("SHEETBASE_AUTH_STATE_CHANGED",function(e,t){r.next(t?t.user:null)})})},e.prototype.createUserWithEmailAndPassword=function(e,n){var o=this;return new Promise(function(t,r){o.apiService.POST("/user/create",{},{credential:{email:e,password:n}}).then(function(e){e.error&&r(e),e.token||(console.error("[Error][Sheetbase][User] No auth endpoint user/create found in backend!"),r(null)),o.ngZone.run(function(){o.userDataService.user=e.user,o.userDataService.token=e.token}),u.setItem("sheetbaseAuthData",e).then(function(){}).catch(function(e){}),i.publish("SHEETBASE_AUTH_STATE_CHANGED",e),t(e)}).catch(r)})},e.prototype.loginWithEmailAndPassword=function(e,n){var o=this;return new Promise(function(t,r){o.userDataService.user&&t({token:o.userDataService.token,user:o.userDataService.user}),o.apiService.POST("/user/login",{},{credential:{email:e,password:n}}).then(function(e){e.error&&r(e),e.token||(console.error("[Error][Sheetbase][User] No auth endpoint user/login found in backend!"),r(null)),o.ngZone.run(function(){o.userDataService.user=e.user,o.userDataService.token=e.token}),u.setItem("sheetbaseAuthData",e).then(function(){}).catch(function(e){}),i.publish("SHEETBASE_AUTH_STATE_CHANGED",e),t(e)}).catch(r)})},e.prototype.signOut=function(){var r=this;return new Promise(function(e,t){r.userDataService.user=null,r.userDataService.token=null,u.removeItem("sheetbaseAuthData").then(function(){}).catch(function(e){}),i.publish("SHEETBASE_AUTH_STATE_CHANGED",null),e(null)})},e.prototype.updateProfile=function(e){var n=this;return new Promise(function(t,r){n.apiService.POST("/user/profile",{},{profileData:e}).then(function(e){e.error&&r(e),e.user||(console.error("[Error][Sheetbase][User] No auth endpoint user/profile found in backend!"),r(null)),n.ngZone.run(function(){n.userDataService.user=e.user}),u.setItem("sheetbaseAuthData",{token:n.userDataService.token,user:e.user}).then(function(){}).catch(function(e){}),i.publish("SHEETBASE_AUTH_STATE_CHANGED",e),t(e.user)}).catch(r)})},e.decorators=[{type:r.Injectable}],e.ctorParameters=function(){return[{type:r.NgZone},{type:c},{type:l}]},e}(),d=function(){function e(e,t){this.ngZone=e,this.apiService=t}return e.prototype.get=function(e){return this.apiService.GET("/file",{id:e})},e.prototype.upload=function(n,o){var i=this;return void 0===o&&(o=null),new a.Observable(function(r){var e=new FileReader;e.onload=function(e){var t={file:Object.assign(i.base64Breakdown(e.target.result),{name:n.name})};o&&(t.folder=o),i.apiService.POST("/file",{},t).then(function(e){r.next(e),r.complete()})},e.readAsDataURL(n)})},e.prototype.base64Breakdown=function(e){var t=e.split(";base64,");return{mimeType:t[0].replace("data:",""),base64String:t[1]}},e.decorators=[{type:r.Injectable}],e.ctorParameters=function(){return[{type:r.NgZone},{type:l}]},e}(),v=function(){function t(){}return t.forRoot=function(e){return{ngModule:t,providers:[{provide:o,useValue:e},s,p,l,h,c,d]}},t.decorators=[{type:r.NgModule}],t}();e.SheetbaseModule=v,e.SpreadsheetService=s,e.DataService=p,e.ApiService=l,e.UserService=h,e.FileService=d,Object.defineProperty(e,"__esModule",{value:!0})});