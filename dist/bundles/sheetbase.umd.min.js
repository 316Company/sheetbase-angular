!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("lodash"),require("@angular/common/http"),require("rxjs")):"function"==typeof define&&define.amd?define(["exports","@angular/core","lodash","@angular/common/http","rxjs"],t):t((e.ng=e.ng||{},e.ng.sheetbase={}),e.ng.core,e._,e.ng.common.http,e.Rx)}(this,function(e,o,r,t,s){"use strict";var n=new o.InjectionToken("SheetbaseConfig"),i=function(e,t,o){return void 0===t&&(t="$key"),void 0===o&&(o="desc"),r.orderBy(e,[t],[o])},a=function(){function e(e,t,o){this.ngZone=e,this.http=t,this.CONFIG=o}return e.prototype.get=function(o,r,n){var a=this;return void 0===r&&(r=null),void 0===n&&(n=null),new s.Observable(function(t){var e=(a.database||{})[o]||{};!e||Object.keys(e).length<1?a.spreadsheetGet({id:a.CONFIG.database,range:o+"!A1:ZZ"},o).then(function(e){a.database=a.database||{},a.database[o]=e,t.next(a.returnData(o,r,n)),t.complete()}).catch(function(e){return s.Observable.throw(e)}):(t.next(a.returnData(o,r,n)),t.complete())})},e.prototype.api=function(n,a,s,i){var u=this;return void 0===n&&(n="GET"),void 0===a&&(a=null),void 0===s&&(s={}),void 0===i&&(i={}),new Promise(function(t,o){u.CONFIG.backend||o({message:"No backend found in the config file!"});var e="https://script.google.com/macros/s/"+u.CONFIG.backend+"/exec";for(var r in a&&(e+="?e="+a),!a&&0<Object.keys(s||{}).length&&(e+="?"),s||{})e+="&"+r+"="+s[r];!a&&0<Object.keys(s||{}).length&&(e=e.replace("?&","?")),"post"===n.toLowerCase()?(i=Object.assign({},i,{apiKey:u.CONFIG.apiKey}),u.http.post(e,JSON.stringify(i),{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).subscribe(function(e){e.error&&o(e),t(e)},o)):(!a&&Object.keys(s).length<1?e+="?apiKey="+u.CONFIG.apiKey:e+="&apiKey="+u.CONFIG.apiKey,u.http.get(e).subscribe(function(e){e.error&&o(e),t(e)},o))})},e.prototype.returnData=function(e,t,o){var r=(this.database||{})[e]||{};if(t)return Object.assign({$key:t},r[t]||{});var n=[];for(var a in r)n.push(Object.assign({$key:a},r[a]));return this.filterResult(n,o)},e.prototype.filterResult=function(e,o){var r=[];if((o=o||{}).orderByKey&&(o.equalTo||!o.equalTo&&"boolean"==typeof o.equalTo)){var n=o.orderByKey.split("/"),a=n[0];n=n.slice(1,n.length),(e||[]).forEach(function(e){var t=e[a]||{};(n||[]).forEach(function(e){if(!t[e])return t=null;t=t[e]}),("boolean"==typeof o.equalTo&&"boolean"==typeof t&&t===o.equalTo||"!null"===o.equalTo&&t||"boolean"!=typeof o.equalTo&&"boolean"!=typeof t&&t===o.equalTo)&&r.push(e)})}else r=e;return r=i(r,o.orderByKey||"id",o.order||"asc"),o.limitToFirst&&(r=r.slice(o.offset||0,o.limitToFirst+(o.offset||0))),o.limitToLast&&(r=r.slice(r.length-o.limitToLast-(o.offset||0),r.length-(o.offset||0))),r},e.prototype.spreadsheetGet=function(r,n,a,s){var i=this;return void 0===n&&(n=null),void 0===a&&(a=null),void 0===s&&(s=!0),new Promise(function(t,e){if(r.range.indexOf(",")<0)i.spreadsheetLoad(r.id,r.range).then(function(e){return i.ngZone.run(function(){t(i.spreadsheetModifyValue(e,n,a,s))})}).catch(e);else{var o="";(r.range.split(",").map(function(e){return e.trim()})||[]).forEach(function(e){o+="&ranges="+e}),i.spreadsheetLoadBatch(r.id,o).then(function(e){return i.ngZone.run(function(){t(i.spreadsheetModifyValue(e,n,a,s))})}).catch(e)}})},e.prototype.spreadsheetLoad=function(o,r){var n=this;return new Promise(function(t,e){n.http.get("https://sheets.googleapis.com/v4/spreadsheets/"+o+"/values/"+r+"?key="+n.CONFIG.apiKey).subscribe(function(e){t(n.spreadsheetTransformValue(e.values))},e)})},e.prototype.spreadsheetTransformValue=function(e){var n=[],a=e[0]||[];return(e.slice(1,e.length)||[]).forEach(function(e){for(var t={},o=0;o<e.length;o++)if(e[o]){var r=e[o];t[a[o]]=r}n.push(t)}),n},e.prototype.spreadsheetLoadBatch=function(o,r){var n=this;return new Promise(function(t,e){n.http.get("https://sheets.googleapis.com/v4/spreadsheets/"+o+"/values:batchGet?"+r+"&key="+n.CONFIG.apiKey).subscribe(function(e){t(n.spreadsheetTransformBatchValue(e.valueRanges))},e)})},e.prototype.spreadsheetTransformBatchValue=function(e){var t=this,o=this.spreadsheetTransformValue(e[0].values||[]),r=[];(e.slice(1,e.length)||[]).forEach(function(e){r.push(t.spreadsheetTransformValue(e.values||[]))});var n=[];return(o||[]).forEach(function(t){(r||[]).forEach(function(e){(e||[]).forEach(function(e){t.key===e.key&&(t=Object.assign(t,e))})}),n.push(t)}),n},e.prototype.spreadsheetModifyValue=function(e,t,o,r){var n=function(e,t){return void 0===t&&(t={}),e};t&&this.CONFIG.modifiers&&this.CONFIG.modifiers[t]&&(n=this.CONFIG.modifiers[t]);var a=null,s=null;return(e||[]).forEach(function(e){for(var t in e){try{e[t]=JSON.parse(e[t])}catch(e){}isNaN(e[t])||Number(e[t])%1!=0||(e[t]=parseInt(e[t])),isNaN(e[t])||Number(e[t])%1==0||(e[t]=parseFloat(e[t])),("string"==typeof e[t]||e[t]instanceof String)&&(e[t]="true"===e[t].toLowerCase()||"false"!==e[t].toLowerCase()&&e[t]),""!==e[t]&&null!==e[t]&&void 0!==e[t]||delete e[t]}e=n(e,{}),(a=a||{})[o?e[o]:e.key||e.slug||""+e.id]=e,(s=s||[]).push(e)}),r?a:s},e.decorators=[{type:o.Injectable}],e.ctorParameters=function(){return[{type:o.NgZone},{type:t.HttpClient},{type:void 0,decorators:[{type:o.Inject,args:[n]}]}]},e}(),u=function(){function t(){}return t.forRoot=function(e){return{ngModule:t,providers:[a,{provide:n,useValue:e}]}},t.decorators=[{type:o.NgModule}],t}();e.SheetbaseModule=u,e.SheetbaseService=a,Object.defineProperty(e,"__esModule",{value:!0})});