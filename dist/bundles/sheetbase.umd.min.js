!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("lodash"),require("@angular/common/http"),require("ionic-angular"),require("rxjs")):"function"==typeof define&&define.amd?define(["exports","@angular/core","lodash","@angular/common/http","ionic-angular","rxjs"],t):t((e.ng=e.ng||{},e.ng.sheetbase={}),e.ng.core,e._,e.ng.common.http,e.ionicAngular,e.Rx)}(this,function(e,n,a,t,o,r){"use strict";var s=new n.InjectionToken("SheetbaseConfig"),f=function(e,t,n,a){void 0===t&&(t=!1),void 0===n&&(n=null),void 0===a&&(a=!1),t&&void 0!==e&&(e=JSON.parse(JSON.stringify(e)));var o=[];for(var r in e)"object"==typeof e[r]?e[r].$key=r:e[r]={$key:r,value:e[r]},o.push(e[r]);return n&&o.splice(n,o.length),a&&o.length<1&&(o=null),o},i=function(e,t,n){return void 0===t&&(t="$key"),void 0===n&&(n="desc"),a.orderBy(e,[t],[n])},u=function(){function e(e,t,n,a){this.ngZone=e,this.http=t,this.events=n,this.CONFIG=a,this.tables=[{name:"categories"},{name:"tags"},{name:"authors"},{name:"posts"},{name:"pages"}]}return e.prototype.db=function(){return{id:this.CONFIG.database,tables:this.tables||[]}},e.prototype.init=function(){var t=this;this.spreadsheetGet({id:this.CONFIG.database,range:"__tables__!A1:C"},null,"name",!1).then(function(e){t.tables=e,t.loadData()}).catch(function(e){t.loadData()})},e.prototype.get=function(s,i,u,l){var c=this;return void 0===i&&(i=null),void 0===u&&(u=null),void 0===l&&(l=!1),new r.Observable(function(o){var r=setInterval(function(){if(c.tables){clearInterval(r),c.database=c.database||{};var e=c.database[s]||{};if(!e||Object.keys(e).length<1){var t=null;(c.tables||[]).forEach(function(e){e.name===s&&(t=e)}),t&&c.loadData([t])}if(i)o.next(Object.assign({$key:i},e[i]||{})),l?o.complete():c.events.subscribe("appData:"+s,function(e){o.next(Object.assign({$key:i},e[i]||{}))});else{var n=[];for(var a in e)n.push(Object.assign({$key:a},e[a]));o.next(c.filterResult(n,u)),l?o.complete():c.events.subscribe("appData:"+s,function(e){delete e.$key,o.next(c.filterResult(f(e,!0),u))})}}},100);setTimeout(function(){clearInterval(r)},1e4)})},e.prototype.loadData=function(e){var n=this;void 0===e&&(e=null),(e||this.tables||[]).forEach(function(t){(e||t.autoload)&&(-1<(n.onTheFlyTracker||[]).indexOf(t.name)||(console.info("GO FLY -> "+t.name+"[]"),n.onTheFlyTracker=n.onTheFlyTracker||[],n.onTheFlyTracker.push(t.name),setTimeout(function(){n.spreadsheetGet({id:n.CONFIG.database,range:t.name+"!"+(t.range||"A1:ZZ")},t.name,t.key).then(function(e){n.database=n.database||{},n.database[t.name]=e,n.events.publish("appData:"+t.name,e),n.onTheFlyTracker.splice(n.onTheFlyTracker.indexOf("table.name"),1)}).catch(function(e){})},100)))})},e.prototype.filterResult=function(e,n){var a=[];if((n=n||{}).orderByKey&&(n.equalTo||!n.equalTo&&"boolean"==typeof n.equalTo)){var o=n.orderByKey.split("/"),r=o[0];o=o.slice(1,o.length),(e||[]).forEach(function(e){var t=e[r]||{};(o||[]).forEach(function(e){if(!t[e])return t=null;t=t[e]}),("boolean"==typeof n.equalTo&&"boolean"==typeof t&&t===n.equalTo||"!null"===n.equalTo&&t||"boolean"!=typeof n.equalTo&&"boolean"!=typeof t&&t===n.equalTo)&&a.push(e)})}else a=e;return a=i(a,n.orderByKey||"id",n.order||"asc"),n.limitToFirst&&(a=a.slice(n.offset||0,n.limitToFirst+(n.offset||0))),n.limitToLast&&(a=a.slice(a.length-n.limitToLast-(n.offset||0),a.length-(n.offset||0))),a},e.prototype.spreadsheetGet=function(a,o,r,s){var i=this;return void 0===o&&(o=null),void 0===r&&(r=null),void 0===s&&(s=!0),new Promise(function(t,e){if(a.range.indexOf(",")<0)i.spreadsheetLoad(a.id,a.range).then(function(e){return i.ngZone.run(function(){t(i.spreadsheetModifyValue(e,o,r,s))})}).catch(e);else{var n="";(a.range.split(",").map(function(e){return e.trim()})||[]).forEach(function(e){n+="&ranges="+e}),i.spreadsheetLoadBatch(a.id,n).then(function(e){return i.ngZone.run(function(){t(i.spreadsheetModifyValue(e,o,r,s))})}).catch(e)}})},e.prototype.spreadsheetLoad=function(n,a){var o=this;return new Promise(function(t,e){o.http.get("https://sheets.googleapis.com/v4/spreadsheets/"+n+"/values/"+a+"?key="+o.CONFIG.apiKey).subscribe(function(e){t(o.spreadsheetTransformValue(e.values))},e)})},e.prototype.spreadsheetTransformValue=function(e){var o=[],r=e[0]||[];return(e.slice(1,e.length)||[]).forEach(function(e){for(var t={},n=0;n<e.length;n++)if(e[n]){var a=e[n];t[r[n]]=a}o.push(t)}),o},e.prototype.spreadsheetLoadBatch=function(n,a){var o=this;return new Promise(function(t,e){o.http.get("https://sheets.googleapis.com/v4/spreadsheets/"+n+"/values:batchGet?"+a+"&key="+o.CONFIG.apiKey).subscribe(function(e){t(o.spreadsheetTransformBatchValue(e.valueRanges))},e)})},e.prototype.spreadsheetTransformBatchValue=function(e){var t=this,n=this.spreadsheetTransformValue(e[0].values||[]),a=[];(e.slice(1,e.length)||[]).forEach(function(e){a.push(t.spreadsheetTransformValue(e.values||[]))});var o=[];return(n||[]).forEach(function(t){(a||[]).forEach(function(e){(e||[]).forEach(function(e){t.key===e.key&&(t=Object.assign(t,e))})}),o.push(t)}),o},e.prototype.spreadsheetModifyValue=function(e,t,n,a){var o=function(e,t){return void 0===t&&(t={}),e};t&&this.CONFIG.modifiers&&this.CONFIG.modifiers[t]&&(o=this.CONFIG.modifiers[t]);var r=null,s=null;return(e||[]).forEach(function(e){for(var t in e){try{e[t]=JSON.parse(e[t])}catch(e){}isNaN(e[t])||Number(e[t])%1!=0||(e[t]=parseInt(e[t])),isNaN(e[t])||Number(e[t])%1==0||(e[t]=parseFloat(e[t])),("string"==typeof e[t]||e[t]instanceof String)&&(e[t]="true"===e[t].toLowerCase()||"false"!==e[t].toLowerCase()&&e[t]),""!==e[t]&&null!==e[t]&&void 0!==e[t]||delete e[t]}e=o(e,{}),(r=r||{})[n?e[n]:e.key||e.slug||""+e.id]=e,(s=s||[]).push(e)}),a?r:s},e.decorators=[{type:n.Injectable}],e.ctorParameters=function(){return[{type:n.NgZone},{type:t.HttpClient},{type:o.Events},{type:void 0,decorators:[{type:n.Inject,args:[s]}]}]},e}(),l=function(){function t(){}return t.forRoot=function(e){return{ngModule:t,providers:[u,{provide:s,useValue:e}]}},t.decorators=[{type:n.NgModule}],t}();e.SheetbaseModule=l,e.SheetbaseConfigService=s,e.SheetbaseService=u,Object.defineProperty(e,"__esModule",{value:!0})});